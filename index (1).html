<!DOCTYPE html>
<html>
<head>
  <title>Learning Bot</title>
</head>
<body>
  <div id="chat"></div>
  <input id="input" placeholder="Type here...">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, get, set, child, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA5xUVdhcvhPUUM9j7r-F8MTZO-8uMsW7c",
      authDomain: "tdssrt-94b2c.firebaseapp.com",
      databaseURL: "https://tdssrt-94b2c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tdssrt-94b2c",
      storageBucket: "tdssrt-94b2c.firebasestorage.app",
      messagingSenderId: "694566871212",
      appId: "1:694566871212:web:2c40b909cc6bfd19a0bf09"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // local cache
    let memory = {};

    async function loadMemory() {
      let snapshot = await get(ref(db, "memory"));
      if (snapshot.exists()) {
        memory = snapshot.val();
      }
    }

    async function saveMemory(key, value) {
      memory[key] = value;
      await update(ref(db, "memory"), { [key]: value });
    }

    function normalize(text) {
      text = text.trim().toLowerCase();
      let stopWords = [
        "what","what's","how","how's","who","who's","where","where's",
        "when","when's","why","does","do","is","are","the","your","of",
        "can","could","would","will","shall","should","did","if","tell","me","about","explain"
      ];
      for (let w of stopWords) {
        if (text.startsWith(w + " ")) {
          text = text.replace(w, "").trim();
        }
      }
      return text;
    }

    function solveMath(text) {
      try {
        if (/^[0-9+\-*/().\s]+$/.test(text)) {
          return eval(text).toString();
        }
      } catch {}
      return null;
    }

    function chat(user) {
      let key = normalize(user);
      let mathAns = solveMath(key);
      if (mathAns !== null) return mathAns;
      if (memory[key]) return memory[key];
      return null;
    }

    const input = document.getElementById("input");
    const chatBox = document.getElementById("chat");

    input.addEventListener("keydown", async e => {
      if (e.key === "Enter") {
        let user = input.value.trim();
        input.value = "";

        let reply = chat(user);

        chatBox.innerHTML += "<p><b>You:</b> " + user + "</p>";

        if (reply) {
          chatBox.innerHTML += "<p><b>Bot:</b> " + reply + "</p>";
        } else {
          let ans = prompt("I don't know. Teach me:");
          if (ans) {
            await saveMemory(normalize(user), ans);
            chatBox.innerHTML += "<p><b>Bot:</b> Learned.</p>";
          }
        }
      }
    });

    // load memory at start
    loadMemory();
  </script>
</body>
</html>